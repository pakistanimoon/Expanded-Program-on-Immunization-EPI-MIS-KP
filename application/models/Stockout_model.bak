<?php
class Stockout_model extends CI_Model {
	//================ Constructor Function Starts ==================//
	public function __construct() {
		parent::__construct();
	}
	//============================ Constructor Function Ends ============================//
	public function get_vacc_stock_out_data($fmonth,$itemId,$distcode=NULL)
	{
		$parts = explode("-",$fmonth);
		if(isset($parts[0]) && isset($parts[1])){
			$query ="select array_agg('cr_r' || cr_table_row_numb || '_f6<1') ids from epi_item_pack_sizes where cr_table_row_numb is not NULL and item_id = $itemId";
			$query = $this->db->query($query);
			$itemsidarr = $query->row()->ids;
			if($itemsidarr){
				$year = $parts[0];
				$monthnum = 'duem'.ltrim($parts[1], '0');
				$selectcolumns = "distcode as code,district as name";
				$table = "districts_wise_maps_paths tbl";					
				$duepart = "(SELECT sum($monthnum) FROM consumptioncompliance where year = '".$year."' and distcode = tbl.distcode)";
				$subcode = " and distcode = tbl.distcode";
				$stockout = "get_pro_level_all_fac_stock_out('$itemsidarr','$fmonth',tbl.distcode)";
				if($distcode){
					$selectcolumns = "uncode as code,ucname as name";
					$table = "uc_wise_maps_paths tbl where tbl.distcode='$distcode'";
					$duepart = "getfacility_count(tbl.uncode,'unioncouncil')";
					$subcode = " and uncode = tbl.uncode";
					$stockout = "get_pro_level_all_fac_stock_out('$itemsidarr','$fmonth','uncode',tbl.uncode)";
				}
				$query ="
				select 
				$selectcolumns,
				path,
				$duepart as due,
				(SELECT count(*) FROM form_b_cr where fmonth = '".$fmonth."' $subcode) as submitted,
				$stockout as stockout 
				from $table";
				$query = $this->db->query($query);
				return $query->result_array();
			}
			return array();
		}
		return array();
	}
}
?>